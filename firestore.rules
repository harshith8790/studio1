/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user-generated content,
 * such as profiles and content logs, is stored in subcollections under that user's unique ID.
 * This ensures that users can only access their own data, providing strong data privacy by default.
 *
 * ## Data Structure
 * - `/users/{userId}`: Root for all private user-specific data.
 * - `/creators/{creatorId}`: Public-facing creator profiles for matching.
 * - `/collaboration_requests/{requestId}`: Private records of collaboration requests.
 * - `/trends/{trendId}`: A top-level collection for globally readable trend data.
 *
 * ## Key Security Decisions
 * - **User Isolation**: All data under `/users/{userId}` is strictly private to the owning user.
 * - **Conditional Public Profiles**: The `/creators` collection is readable by any authenticated user,
 *   but only for documents where the `availability` field is `true`.
 * - **Shared Access for Requests**: The `/collaboration_requests` collection implements a shared
 *   access model where only the involved parties (sender and receiver) can read the document.
 * - **Public Read-Only Data**: The `/trends` collection is publicly readable but locked for writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    function isUserOwnedDoc(userId) {
      return request.resource.data.userId == userId;
    }
    
    function userIdIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // User Data Rules
    // --------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id && request.resource.data.email == resource.data.email;
      allow delete: if isExistingOwner(userId);

      match /brandProfiles/{brandProfileId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && isUserOwnedDoc(userId);
        allow update: if isExistingOwner(userId) && userIdIsImmutable();
        allow delete: if isExistingOwner(userId);
      }

      match /contentLogs/{contentLogId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && isUserOwnedDoc(userId);
        allow update: if isExistingOwner(userId) && userIdIsImmutable();
        allow delete: if isExistingOwner(userId);
      }

      match /contentCalendarEntries/{contentCalendarEntryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && isUserOwnedDoc(userId);
        allow update: if isExistingOwner(userId) && userIdIsImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }

    // Global & Shared Data Rules
    // --------------------------------

    /**
     * @description Controls access to public creator profiles.
     * @path        /creators/{creatorId}
     * @allow       (read) Any authenticated user can read a creator's profile if their `availability` is true.
     * @deny        (write) No client can write to these profiles directly.
     * @principle   Enables discoverability for collaboration while respecting creator privacy choices.
     */
    match /creators/{creatorId} {
      allow get: if isSignedIn() && resource.data.availability == true;
      allow list: if isSignedIn(); // Allow listing, but client must filter for availability = true
      allow create, update, delete: if false; // Managed by backend/trusted process
    }

    /**
     * @description Controls access to collaboration requests.
     * @path        /collaboration_requests/{requestId}
     * @allow       (create) An authenticated user can create a request where they are the sender.
     * @allow       (read) Only the sender or receiver of the request can read it.
     * @deny        (list, update, delete) General listing, updating, or deleting is disallowed for security.
     * @principle   Implements a closed-collaborator model where access is granted only
     *              to users explicitly named in the document.
     */
    match /collaboration_requests/{requestId} {
      allow get: if isSignedIn() && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow list: if false; // Deny general listing to protect privacy.
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false; // Status changes handled by backend logic/functions.
    }

    match /trends/{trendId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}
